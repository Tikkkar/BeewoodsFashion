-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.addresses (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  full_name text NOT NULL,
  phone text NOT NULL,
  address_line text NOT NULL,
  city text NOT NULL,
  district text,
  ward text,
  is_default boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT addresses_pkey PRIMARY KEY (id),
  CONSTRAINT addresses_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.ai_usage_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tenant_id uuid,
  conversation_id uuid,
  model text NOT NULL,
  input_tokens integer DEFAULT 0,
  output_tokens integer DEFAULT 0,
  cost numeric DEFAULT 0,
  purpose text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ai_usage_logs_pkey PRIMARY KEY (id),
  CONSTRAINT ai_usage_logs_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id),
  CONSTRAINT ai_usage_logs_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.chatbot_conversations(id)
);
CREATE TABLE public.banners (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  title text,
  subtitle text,
  image_url text NOT NULL,
  link_url text,
  display_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  button_text character varying DEFAULT 'Shop Now'::character varying,
  button_link character varying DEFAULT '/products'::character varying,
  media_type character varying DEFAULT 'image'::character varying,
  video_url text,
  description text,
  text_color character varying DEFAULT '#FFFFFF'::character varying,
  title_size character varying DEFAULT 'text-5xl'::character varying,
  subtitle_size character varying DEFAULT 'text-xl'::character varying,
  button_style character varying DEFAULT 'primary'::character varying CHECK (button_style::text = ANY (ARRAY['primary'::character varying, 'secondary'::character varying, 'outline'::character varying, 'ghost'::character varying]::text[])),
  text_position character varying DEFAULT 'left'::character varying CHECK (text_position::text = ANY (ARRAY['left'::character varying, 'center'::character varying, 'right'::character varying]::text[])),
  overlay_opacity numeric DEFAULT 0.3 CHECK (overlay_opacity >= 0::numeric AND overlay_opacity <= 0.8),
  animation character varying DEFAULT 'fade'::character varying CHECK (animation::text = ANY (ARRAY['none'::character varying, 'fade'::character varying, 'slide'::character varying, 'zoom'::character varying]::text[])),
  mobile_image_url text,
  start_date timestamp with time zone,
  end_date timestamp with time zone,
  height_mobile integer DEFAULT 500 CHECK (height_mobile >= 300 AND height_mobile <= 1000),
  height_tablet integer DEFAULT 600 CHECK (height_tablet >= 400 AND height_tablet <= 1200),
  height_desktop integer DEFAULT 70 CHECK (height_desktop >= 40 AND height_desktop <= 100),
  height_large integer DEFAULT 80 CHECK (height_large >= 50 AND height_large <= 100),
  show_content boolean DEFAULT true,
  tenant_id uuid,
  CONSTRAINT banners_pkey PRIMARY KEY (id),
  CONSTRAINT banners_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.categories (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name text NOT NULL UNIQUE,
  slug text NOT NULL UNIQUE,
  description text,
  image_url text,
  display_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  tenant_id uuid,
  CONSTRAINT categories_pkey PRIMARY KEY (id),
  CONSTRAINT categories_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.chatbot_conversations (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  platform text NOT NULL DEFAULT 'facebook'::text CHECK (platform = ANY (ARRAY['facebook'::text, 'website'::text])),
  customer_fb_id text,
  user_id uuid,
  session_id text,
  customer_name text,
  customer_phone text,
  customer_avatar text,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'resolved'::text, 'pending_admin'::text])),
  assigned_to_admin boolean DEFAULT false,
  context jsonb DEFAULT '{}'::jsonb,
  last_message_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  customer_zalo_id character varying,
  tenant_id uuid,
  conversion_status text DEFAULT 'pending'::text,
  conversion_value numeric DEFAULT 0,
  converted_at timestamp with time zone,
  quality_score integer DEFAULT 3,
  CONSTRAINT chatbot_conversations_pkey PRIMARY KEY (id),
  CONSTRAINT chatbot_conversations_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT chatbot_conversations_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.chatbot_facebook_settings (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  page_id text,
  page_name text,
  access_token text,
  verify_token text NOT NULL DEFAULT ('bewo_verify_'::text || substr(md5((random())::text), 1, 8)),
  app_id text,
  app_secret text,
  is_connected boolean DEFAULT false,
  webhook_url text,
  last_sync_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  tenant_id uuid,
  auto_post_enabled boolean DEFAULT false,
  auto_post_on_seo_update boolean DEFAULT true,
  auto_post_on_new_product boolean DEFAULT true,
  auto_post_delay_minutes integer DEFAULT 5,
  post_tone text DEFAULT 'friendly'::text CHECK (post_tone = ANY (ARRAY['professional'::text, 'friendly'::text, 'enthusiastic'::text, 'luxury'::text, 'casual'::text, 'urgent'::text])),
  custom_hashtags ARRAY DEFAULT '{}'::text[],
  include_category_hashtags boolean DEFAULT true,
  include_brand_hashtags boolean DEFAULT true,
  max_images integer DEFAULT 10 CHECK (max_images >= 1 AND max_images <= 10),
  preferred_post_times ARRAY DEFAULT '{09:00,12:00,18:00,20:00}'::text[],
  max_posts_per_day integer DEFAULT 10,
  min_interval_minutes integer DEFAULT 60,
  CONSTRAINT chatbot_facebook_settings_pkey PRIMARY KEY (id),
  CONSTRAINT chatbot_facebook_settings_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.chatbot_messages (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  conversation_id uuid,
  sender_type text NOT NULL CHECK (sender_type = ANY (ARRAY['customer'::text, 'bot'::text, 'admin'::text])),
  message_type text DEFAULT 'text'::text CHECK (message_type = ANY (ARRAY['text'::text, 'image'::text, 'quick_reply'::text, 'product_card'::text])),
  content jsonb NOT NULL,
  tokens_used integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  tenant_id uuid,
  CONSTRAINT chatbot_messages_pkey PRIMARY KEY (id),
  CONSTRAINT chatbot_messages_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.chatbot_conversations(id),
  CONSTRAINT chatbot_messages_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.chatbot_orders (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  conversation_id uuid NOT NULL,
  profile_id uuid,
  customer_name text NOT NULL,
  customer_phone text NOT NULL,
  customer_fb_id text,
  shipping_address text NOT NULL,
  shipping_ward text,
  shipping_district text,
  shipping_city text,
  product_ids jsonb NOT NULL DEFAULT '[]'::jsonb,
  product_details jsonb NOT NULL DEFAULT '[]'::jsonb,
  subtotal numeric NOT NULL,
  shipping_fee numeric DEFAULT 30000,
  discount_amount numeric DEFAULT 0,
  total_amount numeric NOT NULL,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'confirmed'::text, 'processing'::text, 'shipped'::text, 'delivered'::text, 'cancelled'::text])),
  notes text,
  cancel_reason text,
  main_order_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  confirmed_at timestamp with time zone,
  updated_at timestamp with time zone DEFAULT now(),
  tenant_id uuid,
  CONSTRAINT chatbot_orders_pkey PRIMARY KEY (id),
  CONSTRAINT chatbot_orders_conversation_fkey FOREIGN KEY (conversation_id) REFERENCES public.chatbot_conversations(id),
  CONSTRAINT chatbot_orders_profile_fkey FOREIGN KEY (profile_id) REFERENCES public.customer_profiles(id),
  CONSTRAINT chatbot_orders_main_order_fkey FOREIGN KEY (main_order_id) REFERENCES public.orders(id),
  CONSTRAINT chatbot_orders_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.chatbot_scenarios (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name text NOT NULL,
  intent text NOT NULL,
  trigger_keywords ARRAY NOT NULL,
  response_type text DEFAULT 'llm'::text CHECK (response_type = ANY (ARRAY['llm'::text, 'template'::text, 'function'::text])),
  response_template text,
  llm_system_prompt text,
  priority integer DEFAULT 5,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  quick_replies jsonb DEFAULT '[]'::jsonb,
  tenant_id uuid,
  CONSTRAINT chatbot_scenarios_pkey PRIMARY KEY (id),
  CONSTRAINT chatbot_scenarios_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.chatbot_training_data (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tenant_id uuid,
  conversation_id uuid,
  customer_message text NOT NULL,
  bot_response text NOT NULL,
  products_recommended jsonb DEFAULT '[]'::jsonb,
  context jsonb DEFAULT '{}'::jsonb,
  outcome text DEFAULT 'positive'::text,
  quality_score integer,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT chatbot_training_data_pkey PRIMARY KEY (id),
  CONSTRAINT chatbot_training_data_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id),
  CONSTRAINT chatbot_training_data_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.chatbot_conversations(id)
);
CREATE TABLE public.chatbot_usage_logs (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  conversation_id uuid,
  input_tokens integer DEFAULT 0,
  output_tokens integer DEFAULT 0,
  total_tokens integer DEFAULT (input_tokens + output_tokens),
  cost numeric DEFAULT 0,
  model text DEFAULT 'claude-3-5-sonnet-20241022'::text,
  created_at timestamp with time zone DEFAULT now(),
  tenant_id uuid,
  CONSTRAINT chatbot_usage_logs_pkey PRIMARY KEY (id),
  CONSTRAINT chatbot_usage_logs_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.chatbot_conversations(id),
  CONSTRAINT chatbot_usage_logs_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.conversation_analytics (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tenant_id uuid,
  conversation_id uuid,
  analysis_data jsonb NOT NULL,
  outcome text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT conversation_analytics_pkey PRIMARY KEY (id),
  CONSTRAINT conversation_analytics_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id),
  CONSTRAINT conversation_analytics_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.chatbot_conversations(id)
);
CREATE TABLE public.conversation_embeddings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  conversation_id uuid NOT NULL,
  message_id uuid,
  content text NOT NULL,
  content_type text DEFAULT 'message'::text CHECK (content_type = ANY (ARRAY['message'::text, 'summary'::text, 'fact'::text])),
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  tenant_id uuid,
  CONSTRAINT conversation_embeddings_pkey PRIMARY KEY (id),
  CONSTRAINT embeddings_conversation_fkey FOREIGN KEY (conversation_id) REFERENCES public.chatbot_conversations(id),
  CONSTRAINT embeddings_message_fkey FOREIGN KEY (message_id) REFERENCES public.chatbot_messages(id),
  CONSTRAINT conversation_embeddings_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.conversation_summaries (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  conversation_id uuid NOT NULL,
  summary_text text NOT NULL,
  key_points jsonb DEFAULT '[]'::jsonb,
  mentioned_products jsonb DEFAULT '[]'::jsonb,
  mentioned_preferences jsonb DEFAULT '[]'::jsonb,
  customer_intent text CHECK (customer_intent = ANY (ARRAY['browsing'::text, 'researching'::text, 'buying'::text, 'asking_support'::text, 'complaining'::text, 'returning'::text])),
  sentiment text CHECK (sentiment = ANY (ARRAY['positive'::text, 'neutral'::text, 'negative'::text])),
  sentiment_score numeric CHECK (sentiment_score >= '-1'::integer::numeric AND sentiment_score <= 1::numeric),
  message_count integer NOT NULL,
  customer_messages integer,
  bot_messages integer,
  duration_minutes integer,
  outcome text CHECK (outcome = ANY (ARRAY['pending'::text, 'purchased'::text, 'not_purchased'::text, 'needs_followup'::text, 'resolved'::text])),
  summary_created_at timestamp with time zone DEFAULT now(),
  conversation_start_at timestamp with time zone,
  conversation_end_at timestamp with time zone,
  tenant_id uuid,
  CONSTRAINT conversation_summaries_pkey PRIMARY KEY (id),
  CONSTRAINT conversation_summaries_conversation_fkey FOREIGN KEY (conversation_id) REFERENCES public.chatbot_conversations(id),
  CONSTRAINT conversation_summaries_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.customer_feedbacks (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  tenant_id uuid,
  customer_name text NOT NULL,
  customer_image text NOT NULL,
  display_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  rating_average numeric DEFAULT 5.0,
  total_responses integer DEFAULT 0,
  CONSTRAINT customer_feedbacks_pkey PRIMARY KEY (id),
  CONSTRAINT customer_feedbacks_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.customer_interests (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  customer_profile_id uuid NOT NULL,
  product_id uuid NOT NULL,
  interest_type text NOT NULL CHECK (interest_type = ANY (ARRAY['viewed'::text, 'asked'::text, 'liked'::text, 'added_to_cart'::text, 'purchased'::text])),
  interaction_context text,
  message_id uuid,
  view_count integer DEFAULT 1,
  last_viewed_at timestamp with time zone DEFAULT now(),
  sentiment text CHECK (sentiment = ANY (ARRAY['positive'::text, 'neutral'::text, 'negative'::text, NULL::text])),
  created_at timestamp with time zone DEFAULT now(),
  tenant_id uuid,
  CONSTRAINT customer_interests_pkey PRIMARY KEY (id),
  CONSTRAINT customer_interests_profile_fkey FOREIGN KEY (customer_profile_id) REFERENCES public.customer_profiles(id),
  CONSTRAINT customer_interests_product_fkey FOREIGN KEY (product_id) REFERENCES public.products(id),
  CONSTRAINT customer_interests_message_fkey FOREIGN KEY (message_id) REFERENCES public.chatbot_messages(id),
  CONSTRAINT customer_interests_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.customer_memory_facts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  customer_profile_id uuid NOT NULL,
  fact_type text NOT NULL CHECK (fact_type = ANY (ARRAY['preference'::text, 'constraint'::text, 'life_event'::text, 'complaint'::text, 'compliment'::text, 'special_request'::text, 'personal_info'::text])),
  fact_text text NOT NULL,
  fact_category text,
  source_message_id uuid,
  source_conversation_id uuid,
  extracted_at timestamp with time zone DEFAULT now(),
  extraction_method text DEFAULT 'manual'::text CHECK (extraction_method = ANY (ARRAY['manual'::text, 'ai'::text, 'rule-based'::text])),
  importance_score integer DEFAULT 5 CHECK (importance_score >= 1 AND importance_score <= 10),
  is_active boolean DEFAULT true,
  expires_at timestamp with time zone,
  confirmed boolean DEFAULT false,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  tenant_id uuid,
  CONSTRAINT customer_memory_facts_pkey PRIMARY KEY (id),
  CONSTRAINT memory_facts_profile_fkey FOREIGN KEY (customer_profile_id) REFERENCES public.customer_profiles(id),
  CONSTRAINT memory_facts_message_fkey FOREIGN KEY (source_message_id) REFERENCES public.chatbot_messages(id),
  CONSTRAINT memory_facts_conversation_fkey FOREIGN KEY (source_conversation_id) REFERENCES public.chatbot_conversations(id),
  CONSTRAINT customer_memory_facts_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.customer_memory_facts_backup (
  id uuid,
  customer_profile_id uuid,
  fact_type text,
  fact_text text,
  fact_category text,
  source_message_id uuid,
  source_conversation_id uuid,
  extracted_at timestamp with time zone,
  extraction_method text,
  importance_score integer,
  is_active boolean,
  expires_at timestamp with time zone,
  confirmed boolean,
  metadata jsonb,
  created_at timestamp with time zone,
  updated_at timestamp with time zone
);
CREATE TABLE public.customer_profiles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  conversation_id uuid UNIQUE,
  customer_fb_id text,
  user_id uuid,
  session_id text,
  full_name text,
  preferred_name text,
  phone text UNIQUE,
  email text,
  address text,
  gender text CHECK (gender = ANY (ARRAY['female'::text, 'male'::text, 'other'::text, NULL::text])),
  age_range text,
  location text,
  height integer CHECK (height IS NULL OR height >= 100 AND height <= 250),
  weight integer CHECK (weight IS NULL OR weight >= 30 AND weight <= 200),
  usual_size text CHECK (usual_size = ANY (ARRAY['XS'::text, 'S'::text, 'M'::text, 'L'::text, 'XL'::text, 'XXL'::text, NULL::text])),
  body_type text CHECK (body_type = ANY (ARRAY['slim'::text, 'average'::text, 'curvy'::text, 'athletic'::text, NULL::text])),
  style_preference jsonb DEFAULT '[]'::jsonb,
  color_preference jsonb DEFAULT '[]'::jsonb,
  material_preference jsonb DEFAULT '[]'::jsonb,
  price_range jsonb,
  total_orders integer DEFAULT 0,
  total_spent numeric DEFAULT 0,
  average_order_value numeric DEFAULT 0,
  last_purchase_date timestamp with time zone,
  favorite_categories jsonb DEFAULT '[]'::jsonb,
  total_messages integer DEFAULT 0,
  total_sessions integer DEFAULT 1,
  first_interaction_at timestamp with time zone DEFAULT now(),
  last_interaction_at timestamp with time zone DEFAULT now(),
  notes text,
  tags jsonb DEFAULT '[]'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  shipping_address_line text,
  shipping_ward text,
  shipping_district text,
  shipping_city text,
  engagement_score integer DEFAULT 0,
  last_order_at timestamp with time zone,
  zalo_user_id text,
  zalo_consent_date timestamp with time zone,
  zalo_consent_active boolean DEFAULT true,
  tenant_id uuid,
  CONSTRAINT customer_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT customer_profiles_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.chatbot_conversations(id),
  CONSTRAINT customer_profiles_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT customer_profiles_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.discounts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  code text NOT NULL UNIQUE,
  discount_type text NOT NULL CHECK (discount_type = ANY (ARRAY['percentage'::text, 'fixed_amount'::text])),
  value numeric NOT NULL CHECK (value > 0::numeric),
  is_active boolean DEFAULT true,
  valid_from timestamp with time zone,
  valid_until timestamp with time zone,
  min_purchase_amount numeric DEFAULT 0,
  usage_limit integer,
  created_at timestamp with time zone DEFAULT now(),
  tenant_id uuid,
  CONSTRAINT discounts_pkey PRIMARY KEY (id),
  CONSTRAINT discounts_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.facebook_posts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tenant_id uuid NOT NULL,
  fb_post_id text,
  fb_page_id text NOT NULL,
  post_type text NOT NULL DEFAULT 'product_update'::text CHECK (post_type = ANY (ARRAY['product_update'::text, 'new_product'::text, 'sale'::text, 'flash_sale'::text, 'restock'::text, 'showcase'::text, 'manual'::text])),
  post_tone text DEFAULT 'friendly'::text CHECK (post_tone = ANY (ARRAY['professional'::text, 'friendly'::text, 'enthusiastic'::text, 'luxury'::text, 'casual'::text, 'urgent'::text])),
  caption text NOT NULL DEFAULT ''::text,
  caption_preview text,
  hashtags ARRAY DEFAULT '{}'::text[],
  image_urls ARRAY NOT NULL DEFAULT '{}'::text[],
  product_url text,
  product_id uuid,
  product_slug text,
  product_name text,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['draft'::text, 'pending'::text, 'scheduled'::text, 'posting'::text, 'posted'::text, 'failed'::text, 'cancelled'::text])),
  triggered_by text DEFAULT 'manual'::text,
  scheduled_at timestamp with time zone,
  posted_at timestamp with time zone,
  fb_response jsonb DEFAULT '{}'::jsonb,
  error_message text,
  retry_count integer DEFAULT 0,
  engagement_metrics jsonb DEFAULT '{"likes": 0, "reach": 0, "clicks": 0, "shares": 0, "comments": 0, "impressions": 0}'::jsonb,
  ai_metadata jsonb DEFAULT '{}'::jsonb,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  auto_post boolean NOT NULL DEFAULT false,
  CONSTRAINT facebook_posts_pkey PRIMARY KEY (id),
  CONSTRAINT facebook_posts_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id),
  CONSTRAINT facebook_posts_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(id),
  CONSTRAINT facebook_posts_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.feedback_responses (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  feedback_id uuid NOT NULL,
  rating integer NOT NULL CHECK (rating >= 1 AND rating <= 5),
  comment text NOT NULL,
  order_id uuid,
  product_ids jsonb DEFAULT '[]'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT feedback_responses_pkey PRIMARY KEY (id),
  CONSTRAINT feedback_responses_feedback_id_fkey FOREIGN KEY (feedback_id) REFERENCES public.customer_feedbacks(id)
);
CREATE TABLE public.function_def_backups (
  oid oid NOT NULL,
  func_name text,
  created_at timestamp with time zone DEFAULT now(),
  def text,
  CONSTRAINT function_def_backups_pkey PRIMARY KEY (oid)
);
CREATE TABLE public.inventory_logs (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  product_id uuid NOT NULL,
  product_size_id uuid,
  change_type text NOT NULL CHECK (change_type = ANY (ARRAY['import'::text, 'export'::text, 'adjustment'::text, 'order'::text, 'return'::text, 'damaged'::text, 'lost'::text, 'found'::text])),
  quantity_change integer NOT NULL,
  stock_before integer NOT NULL,
  stock_after integer NOT NULL,
  reason text,
  reference_type text,
  reference_id uuid,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  tenant_id uuid,
  metadata jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT inventory_logs_pkey PRIMARY KEY (id),
  CONSTRAINT inventory_logs_product_fkey FOREIGN KEY (product_id) REFERENCES public.products(id),
  CONSTRAINT inventory_logs_size_fkey FOREIGN KEY (product_size_id) REFERENCES public.product_sizes(id),
  CONSTRAINT inventory_logs_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id),
  CONSTRAINT inventory_logs_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.order_items (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  order_id uuid,
  product_id uuid,
  product_name text NOT NULL,
  product_image text,
  size text,
  quantity integer NOT NULL,
  price numeric NOT NULL,
  subtotal numeric NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  tenant_id uuid,
  weight_g integer DEFAULT 0,
  total_weight_g integer DEFAULT 0,
  product_code text,
  product_sku text,
  CONSTRAINT order_items_pkey PRIMARY KEY (id),
  CONSTRAINT order_items_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT order_items_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(id),
  CONSTRAINT order_items_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.orders (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  order_number text NOT NULL UNIQUE,
  customer_name text NOT NULL,
  customer_email text,
  customer_phone text NOT NULL,
  shipping_address text NOT NULL,
  shipping_city text,
  shipping_district text,
  shipping_ward text,
  subtotal numeric NOT NULL,
  shipping_fee numeric DEFAULT 0,
  total_amount numeric NOT NULL,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'processing'::text, 'shipping'::text, 'completed'::text, 'cancelled'::text])),
  payment_method text DEFAULT 'cod'::text CHECK (payment_method = ANY (ARRAY['cod'::text, 'vnpay'::text, 'bank_transfer'::text])),
  payment_status text DEFAULT 'unpaid'::text CHECK (payment_status = ANY (ARRAY['pending'::text, 'paid'::text, 'failed'::text, 'refunded'::text])),
  notes text,
  cancelled_reason text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  discount_amount integer DEFAULT 0,
  applied_discount_code text,
  user_roles text,
  tenant_id uuid,
  CONSTRAINT orders_pkey PRIMARY KEY (id),
  CONSTRAINT orders_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT orders_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.product_categories (
  product_id uuid NOT NULL,
  category_id uuid NOT NULL,
  CONSTRAINT product_categories_pkey PRIMARY KEY (product_id, category_id),
  CONSTRAINT product_categories_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(id),
  CONSTRAINT product_categories_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.categories(id)
);
CREATE TABLE public.product_images (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  product_id uuid,
  image_url text NOT NULL,
  is_primary boolean DEFAULT false,
  display_order integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT product_images_pkey PRIMARY KEY (id),
  CONSTRAINT product_images_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(id)
);
CREATE TABLE public.product_sizes (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  product_id uuid,
  size text NOT NULL,
  stock integer DEFAULT 0,
  weight_g integer,
  CONSTRAINT product_sizes_pkey PRIMARY KEY (id),
  CONSTRAINT product_sizes_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(id)
);
CREATE TABLE public.products (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name text NOT NULL,
  slug text NOT NULL UNIQUE,
  description text,
  price numeric NOT NULL,
  original_price numeric,
  stock integer DEFAULT 0,
  is_featured boolean DEFAULT false,
  is_active boolean DEFAULT true,
  view_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  attributes jsonb DEFAULT '{}'::jsonb,
  seo_title text,
  seo_description text,
  seo_keywords text,
  tenant_id uuid,
  brand_name text,
  product_code text,
  weight_g integer DEFAULT 0,
  length_cm integer DEFAULT 0,
  width_cm integer DEFAULT 0,
  height_cm integer DEFAULT 0,
  CONSTRAINT products_pkey PRIMARY KEY (id),
  CONSTRAINT products_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.reviews (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  product_id uuid,
  user_id uuid,
  order_id uuid,
  rating integer NOT NULL CHECK (rating >= 1 AND rating <= 5),
  comment text,
  is_verified_purchase boolean DEFAULT false,
  is_approved boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  tenant_id uuid,
  CONSTRAINT reviews_pkey PRIMARY KEY (id),
  CONSTRAINT reviews_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(id),
  CONSTRAINT reviews_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT reviews_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT reviews_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.shipments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tenant_id uuid NOT NULL,
  order_id uuid NOT NULL,
  carrier_code text DEFAULT 'J&T'::text,
  tracking_number text,
  shipping_service_type text DEFAULT 'EXPRESS'::text,
  cod_amount numeric DEFAULT 0,
  insurance_value numeric DEFAULT 0,
  shipping_fee_actual numeric DEFAULT 0,
  total_weight_g integer DEFAULT 0,
  dimension_lwh text,
  items_summary text,
  note_for_shipper text,
  status text DEFAULT 'ready_to_pick'::text CHECK (status = ANY (ARRAY['ready_to_pick'::text, 'picking'::text, 'delivering'::text, 'delivered'::text, 'returned'::text, 'cancelled'::text, 'exception'::text])),
  jnt_response_json jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  receiver_name text,
  receiver_phone text,
  receiver_address_detail text,
  product_code text,
  product_type text,
  service_type text DEFAULT 'EXPRESS'::text,
  service_package text,
  payment_method text DEFAULT 'PP_CASH'::text,
  shipping_fee_customer integer DEFAULT 0,
  cod_type text,
  package_weight_g integer,
  package_length_cm integer,
  package_width_cm integer,
  package_height_cm integer,
  package_count integer DEFAULT 1,
  product_value integer DEFAULT 0,
  note text,
  CONSTRAINT shipments_pkey PRIMARY KEY (id),
  CONSTRAINT shipments_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT shipments_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.stock_alerts (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  product_id uuid NOT NULL,
  product_size_id uuid,
  alert_type text NOT NULL CHECK (alert_type = ANY (ARRAY['low_stock'::text, 'out_of_stock'::text, 'overstock'::text])),
  threshold integer NOT NULL,
  current_stock integer NOT NULL,
  is_resolved boolean DEFAULT false,
  resolved_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  tenant_id uuid,
  CONSTRAINT stock_alerts_pkey PRIMARY KEY (id),
  CONSTRAINT stock_alerts_product_fkey FOREIGN KEY (product_id) REFERENCES public.products(id),
  CONSTRAINT stock_alerts_size_fkey FOREIGN KEY (product_size_id) REFERENCES public.product_sizes(id),
  CONSTRAINT stock_alerts_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.subscription_plans (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  slug text NOT NULL UNIQUE,
  description text,
  price_monthly numeric NOT NULL DEFAULT 0,
  price_yearly numeric NOT NULL DEFAULT 0,
  currency text DEFAULT 'VND'::text,
  limits jsonb NOT NULL DEFAULT '{}'::jsonb,
  is_popular boolean DEFAULT false,
  display_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT subscription_plans_pkey PRIMARY KEY (id)
);
CREATE TABLE public.tenant_api_keys (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tenant_id uuid,
  service text NOT NULL CHECK (service = ANY (ARRAY['gemini'::text, 'openai'::text, 'facebook'::text, 'zalo'::text, 'claude'::text, 'instagram'::text])),
  api_key_encrypted text,
  api_secret_encrypted text,
  access_token_encrypted text,
  config jsonb DEFAULT '{}'::jsonb,
  is_active boolean DEFAULT true,
  expires_at timestamp with time zone,
  last_used_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tenant_api_keys_pkey PRIMARY KEY (id),
  CONSTRAINT tenant_api_keys_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.tenant_subscriptions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tenant_id uuid,
  plan_id uuid,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'past_due'::text, 'cancelled'::text, 'expired'::text])),
  billing_cycle text DEFAULT 'monthly'::text CHECK (billing_cycle = ANY (ARRAY['monthly'::text, 'yearly'::text])),
  amount numeric NOT NULL,
  currency text DEFAULT 'VND'::text,
  payment_method text,
  current_period_start timestamp with time zone DEFAULT now(),
  current_period_end timestamp with time zone DEFAULT (now() + '30 days'::interval),
  cancel_at_period_end boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tenant_subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT tenant_subscriptions_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id),
  CONSTRAINT tenant_subscriptions_plan_id_fkey FOREIGN KEY (plan_id) REFERENCES public.subscription_plans(id)
);
CREATE TABLE public.tenant_usage_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tenant_id uuid,
  usage_type text NOT NULL,
  quantity integer DEFAULT 1,
  cost numeric DEFAULT 0,
  billing_period date DEFAULT CURRENT_DATE,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tenant_usage_logs_pkey PRIMARY KEY (id),
  CONSTRAINT tenant_usage_logs_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.tenant_users (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tenant_id uuid,
  auth_user_id uuid,
  email text NOT NULL,
  full_name text,
  avatar_url text,
  phone text,
  role text DEFAULT 'owner'::text CHECK (role = ANY (ARRAY['owner'::text, 'admin'::text, 'member'::text, 'viewer'::text])),
  permissions jsonb DEFAULT '[]'::jsonb,
  is_active boolean DEFAULT true,
  last_login_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tenant_users_pkey PRIMARY KEY (id),
  CONSTRAINT tenant_users_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id),
  CONSTRAINT tenant_users_auth_user_id_fkey FOREIGN KEY (auth_user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.tenants (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  business_name text NOT NULL,
  business_type text DEFAULT 'fashion'::text CHECK (business_type = ANY (ARRAY['fashion'::text, 'electronics'::text, 'food'::text, 'beauty'::text, 'other'::text])),
  subdomain text UNIQUE,
  custom_domain text UNIQUE,
  logo_url text,
  primary_color text DEFAULT '#3B82F6'::text,
  secondary_color text DEFAULT '#10B981'::text,
  custom_css text,
  owner_email text NOT NULL,
  owner_phone text,
  business_address text,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['trial'::text, 'active'::text, 'suspended'::text, 'cancelled'::text])),
  onboarding_completed boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  trial_started_at timestamp with time zone DEFAULT now(),
  trial_ends_at timestamp with time zone DEFAULT (now() + '365 days'::interval),
  activated_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  metadata jsonb DEFAULT '{}'::jsonb,
  settings jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT tenants_pkey PRIMARY KEY (id)
);
CREATE TABLE public.users (
  id uuid NOT NULL,
  email text NOT NULL UNIQUE,
  full_name text,
  phone text,
  avatar_url text,
  role text DEFAULT 'customer'::text CHECK (role = ANY (ARRAY['customer'::text, 'admin'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT users_pkey PRIMARY KEY (id),
  CONSTRAINT users_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id)
);
CREATE TABLE public.wishlists (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  product_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  tenant_id uuid,
  CONSTRAINT wishlists_pkey PRIMARY KEY (id),
  CONSTRAINT wishlists_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT wishlists_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(id),
  CONSTRAINT wishlists_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);
CREATE TABLE public.zalo_zns_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  order_number text NOT NULL,
  zalo_user_id text NOT NULL,
  customer_phone text,
  template_id text,
  status text NOT NULL CHECK (status = ANY (ARRAY['sent'::text, 'failed'::text, 'pending'::text])),
  response jsonb,
  error_message text,
  sent_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  tenant_id uuid,
  CONSTRAINT zalo_zns_logs_pkey PRIMARY KEY (id),
  CONSTRAINT zalo_zns_logs_tenant_id_fkey FOREIGN KEY (tenant_id) REFERENCES public.tenants(id)
);